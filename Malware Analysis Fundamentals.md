# Malware Analysis Fundamentals 
- Malware: code that is used to perform malicious actions.

### Malware Analysis Goals
- Assess the nature of malware threats
- Determine the scope of the indicdent
- Eradicate malicious artifacts
- Strengthen your ability to handle malware incidents 

- Stages of malware analysis techniques increase in complexity 
- Most Complex:
- Manual Code Reversing
- Interactive Behavior analysis 
- Static Properties analysis
- Fully automated analysis 

## Static Properties Analysis 
- Static properties are also called metadata 
- Entails examinin gthe strings embedded into the file
- Overall file structure
- Header data
- Does not include running the actual file 
- Automated and static analysis allow an analyst to justify allocating additional time to taking a closer look at the specimen 

## Interaction with other Infosec Professions
- <strong>Input to REM staff</strong>
- Verbal reports
- Suspicious files
- File system image 
- Memory image
- Network Logs
- Anomaly observations 
- <strong>Output from REM staff</strong>
- What malware does
- How to identify it
- Attackers profile 
- IR recommendations
- Reports and IOCs
- Malware trends 

### What to include in a malware analysis report 
- Determine how detailed and formal the output of your malware analysis needs to be 
- If a formal report is needed:
- **Summany of the analysis:** Key takeaways the reader should get from the report regarding the specimens nature, origin, caabilities, and other relavant characteristics
- **Identification:** The type of file, its name, size, and hashes, malware name, and current antivirus detection capabilities
- **Characteristics:** The specimens capabilities for infecting files, self-preservation, spreading, leaking data, interacting with the attacker
- **Dependencies:** Files and network resources related to the specimens functionality such as supported OS version and required initialization files, custom DLLs, executables, URLs, and scripts
- **Behavioral and code analysis findings:** Overview of the analysts behavioral, as well as static and dynamic code analysis observations
- **Supporting Figures:** Logs, screenshots, string excerpts, function listings, and other exhibits that support the investigators findings
- **Incident recommendations:** Indicators for detecting the speciment on other systems and networks, and possible for eradication steps
#### Templates 
- https://github.com/MAECProject/schemas/wiki/Malware-Capabilities
- https://github.com/MBCProject/mbc-markdown
[Malware_Analysis_Template.docx](https://github.com/jtaubs1/Reverse-Engineering-Malware/files/8701238/Malware_Analysis_Template.docx)

## Open Source Malware Research
- **Malware data repositories:** VT, #totalhash
- **Multi-engine antivirus scanners:** VT, MetaDefender, VirSCAN, AVCaesar
- **File Reputation:** Malware Hash Registry, Hashsets, Windindex
- **Automated sandboxes:** Any.run, CAPE, Intezer Analye, Hybrid Analysis
- **Website investigation:** vURL, Quttera, urlscan.io
- **Other threat intelligence:** Shodan, Open Threat Exchange, RiskIQ Community Edition 

### Dont use your normal internet connection when interacting with sites outside your lab during the investigation
- Tor is a reasonable option, but adversaries can track exit nodes
- Commercial VPN services can work `www.for610.com/algo`
- Set up your own VPN in the cloud 
- Remember to check for DNS leakage in the case the adversary is checking authoritative DNS server logs for malicious domains
- You could also deploy a transient lab in a public cloud
- **Note:** Check for DNS leakage `www.for610.com/dnsleak`

### Self Defending Malware
- Malware might include self defending capabilities
- Detect virtualization, monitoring, analysis tools
- Detect or confuse code analysis tools such as debuggers or disassemblers 
- **If it detects its being analyzed it might**
- Terminate itself
- Put itself to sleep
- Interfere with analysis tools
- Exhibit different characteristics

- **There are ways to deal with malware that detects analysis tools**
- Could use physical system
- Clone a clean parition with Clonezilla, FOG, and dd
- Store the clean copy away from the system you are infecting 
- At the end of the analysis restore the infected partition with the clean copy
- Can also restore the clean image over the network with PXE booting
- **Instructions** https://for610.com/cape-fog

- **The Lab should include tools that can examine the sample statically and dynamically**
- **Static Properties Analysis** - PeStudio, strings, CFF Explorer, peframe, Detect It Easy, etc
- **Behavioral Analysis** - Process Hacker, Process Monitor, RegShot, Wireshark, fakedns, etc
- **Code Analysis** - Ghidra, x64db/x32db, OllyDumpEx, runsc, Scylla, etc

## Static Properties Analysis 
- See [brbbot-analysis.md](https://github.com/jtaubs1/Reverse-Engineering-Malware/blob/main/malware/day1/brbbot-analysis.md)
**EXE Info Download** - https://for610.com/exeinfope
**Remnux Static Properties Tools** - https://for610.com/remnux-static-prop

## Behavioral Analysis 
- See [brbbot-analysis.md](https://github.com/jtaubs1/Reverse-Engineering-Malware/blob/main/malware/day1/brbbot-analysis.md)
- **Process Hacker** - Replaces built-in Task Manager similar to Microsofts Process Explorer
- **Process Monitor** - Records interactions of processes with the registry, file system, and other processes. https://for610.com/procmon
- **RegShot** - Highlights changes to the file system and the registry https://for610.com/regshot
- **ProcDOT** - Visulaizes Process Monitor logs for easier analysis https://procdot.com
- **Wireshark** - Sniffs the network and captures packets 
- **TCPLogView** - "monitors" the open TCP connections on your system https://for610.com/tcplogview

### fakedns
- It can redirect the traffic from the infected host to an additional vm you control
- Resolves all hostname queries to the IP address of your REMnux VM
- Use `nslookup example.com` to test that it is working --> should point to REMnux 

## Code Analysis Essentials 
- **IDA** - A popular disassembler https://for610.com/ida
- **Windbg** - a powerful free windows debugger from MSFT https://for610.com/windbg
- **Cutter** - an open source toolkit code analysis installed on REMnux https://cutter.re
- **Binary Ninja** - a commercial disassembler that is especially strong for automated analysis tasks https://binary.ninja
- **Hopper** - A commercial disassembler and decompiler that runs on OS X and Linux https://hopperapp.com

- **Analysts employ several code analyis approaches when reverse engineering malicious software**
- **Dissassembling** - Involves translating binary machine level instructions to human readable assembly language code
- **Decompiling** - Involves going a step further to generate an approximation of the origional programs source code 

- Dynamic code level analysis sometimes called **debugging** involves examining the code while running the program 
- Static code level analysis involves using a **disassembler** or **decompiler** to examine the code without actually executing it
- **Emulating** the execution of the code usues specialised tools to preview the key actions the speciment will take when it runs

- **Emulate the execution of a program to preview its capabilities**
- Emulators dont replace disassemblers and debuggers but they can 
- Provide and overview of the capabilities
- Suggest code areas worth analyzing more e.g. functions
- Emulators are especially useful for examining API-level activity 
- Emulators are confused by unfamiliar instructions of API calls 
- Examples of emulators are `speakeasy` and `capa`
## speakeasy
````
run_speakeasy.py -t brbbot.exe -o speakeasy.json 2> speakeasy.txt
````
- Parse .json output with `jq`
````
jq ".entry_points[].apis[].api_name" speakeasy.json | more
````
- https://for610.com/speakeasy 
- `-o` directs `speakeasy` to save its output using the json format
- The script sents the rest of its output to stderr
- Load the output into vscode
````
code speakeasy.txt
````
- Look into interesting API calls as that can feed `ghidra` or `x64/32db` analysis later
## Capa
- https://for610.com/capa
- Capa is not good for packed samples
- capa automatically identifies the specimens capabilities that malware analysts typically want to see 
- Maps observed capabilities to ATT&CK and MBC frameworks for additional insight
- https://for610.com/mbc
- https://for610.com/attack-framework
````
capa brbbot.exe | more
````
- use `-vv` with capa for additional insights
- will display the name of the corresponding API call and the location in the code that invoked that function
- example will see `InternetReadFile` at `0x140001840` --> will be a great place to set a breakpoint as malware often uses that for C2

## x64/32db
- Shortcuts:
````
Run - F9
Run until selection - F4
Pause - F12
Restart - Ctrl+F2
Step Into - F7
Step Over F8
Run to user code - Alt+F9
````
- Commands: 
````
SetBPX ReadFile --> Sets a breakpoint on API Call Readfile
bp ReadFile --> Shortcut for above command
````
- Note API calls are case sensitive 
- `RIP` on x64 is register that contains the address for the current instruction
- `EIP` on x86 is the register that contains the address for the current instruction
- **Registers** are special locations in the CPU that are very efficient at storing smal amounts as data
### Note About Breakpoints in x64/32db
- When you set a BP on an API call and execute until selction / Run it will drop you down to the API call
- We want to see the code implemented by the developer called `user code`
- To acomplush this we want to allow the API call to finish executing and pause once it reaches `user code`
- To do this, once you hit your BP click on the `DeBug menu --> run to user code` or `Alt+F9`



















