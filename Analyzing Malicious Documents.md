# Analyzing Malicious Documents 
- **PDF files can possess powerful capabilities that adversaries misuse to infect systems**
- The structure and contents of a PDF file are defined using objects, which issue directives using ASCII based keywords
- Same risky keywords include 
````
Execute Embedded Javascript --> /JS /Javascript /AcroForm /XFA
Try launching external or embedded programs --> /Launch /EmbeddedFiles
Take actin automatically when the PDF file is opened --> /AA /OpenAction
Interact with websites --> /URI /SubmitForm
````
- **A PDF file is a collection of elements**
````
header --> %PDF-1.6
object --> object delimited with: 
X Y obj 
endobj
...
xref --> Table with offsets of objects in the file
trailer --> Lists the number of objects and the offset of xref
````
- **PDF objects can reference eachother and specify actions**
- Indirect object 1 0 references 43 0
````
1 0 obj 
Type: /Page
<<
  /AA /O 43 O R
>>
endobj
````
- **Streams can encode various data**
````
44 0 obj 
<<
  /Filter 
    [/FlatDecode]
  /Length 463
>>
stream
    encoded contents
endstream 
endobj
````
- **Always start by opening the sample in vs-code**
````
unzip steel1.zip
code steel1.pdf
````
- **Use `pdfid.py` for an initial perspective to check for risky keywords**
- `pdfid.py` scans for suspicious keywords without formally parsing the PDF file
- Its useful for an initial review to inform the next steps 
- The `/URI` keyword indicates clickable URLs can be used in PDFs as phishing bait 
- We use "keyword" in a generic sense through PDF specs use other terms 
````
pdfid.py steel1.pdf
````
- **Use `pdf-parser.py` for a more detailed look at the PDF file**
- The `-a` parameter to `pdf-parser.py` shows statistics 
- Because `pdf-parser.py` properly parses PDF syntac, its output is more accurate than that of `pdfid.py`
````
pdf-parser.py steel1.pdf -a 
````
- **The `-k` parameter shows just the values for the given key**
````
pdf-parser.py steel1.pdf -k /URI
````
## Images in PDF Documents
- The attacker tries to persuade the victim to clicking on the picture 
- To locate images in the PDF file, look for objects of type `/XObject`
## Examine an Object
- Use the `-o` parameter to `pdf-parser.py` to examine object 6 which contains `/XObject`
````
pdf-parser.py steel1.pdf -o 6
````
````
obj 6 0
  Type: /XObject
  Referencing 7 0 R
  Contains Stream     <-- Object includes encoded data
  
  <<
    /Type /XObject
    /Subtype /Image
    /Width 625      <-- Image size is 625 x 155 pixels
    /Height 155
    /BitsPerComponent 8
    /ColorSpace /DeviceRBG
    /Length 7 0 R
    /Filter /DCTDecode      <-- This decoding is used for JPEG images
  >>
````
## Extract and view the image object 
````
pdf-parser.py steel1.pdf -o 6 -d object6.jpg
````
- **Follow the trail of references that leads to object 6 to see if the strail starts with a link**
- The `-r` parameter finds a reference to the specified object
- Object 6 which was of type `/XObject` is referenced by object 13
````
obj 13 0 
  Type:
  Referencing: 4 0 R, 3 0 R, 8 0 R, 9 0 R, 6 0 R
  
  <<
    /ColorSpace
      <<
        /PCSp 4 0 R
        /CSp /DeviceRGB
        /CSpg /DeviceGray
      >>
    /ExtGState
````
- Note: `/Annotes` offers a way to associate a link with an object
- Continue to follow the trail of references
- If you see `/Annotes 14 0 R` --> Look at object 14 now 

## Dealing with Malicious Websites / Retrieving malicious 2nd stages
- One-by-one requests using `wget` or `curl`
- Recomment spoofing HTTP headers to make these requests look more like a normal web browser....Especially the UA strings for `wget` and `curl`!!!!
- Can also tweak the config files of `wget` and `curl` 
````
~/.wgetrc, ~/.curlrc
````
- Specialized tools such as `Pinpoint` or `Scout`
- Honeyclients software such as `Thug`
- Real borwser on a purposefully vulnerable Windows system enabling the website to infect the lab machine
````
Activate behavioral monitoring tools to observe the infection
Capture network traffic 
If using a sniffer such as Fiddler configure it to save SSL keys 
Visit the website from several different IPs to see if its behavior changes 
````
## View PDF Object Streams
````
pdf-parser.py steel2.pdf -O -a
````
- If you see an `/ObjStream` from the output of `pdf-parser.py steel2.pdf -a` command then you need to view the `/ObjStream`
- `pdf-parser.py` does not examine object streams by default 
### Find all objects that refer to object 10
````
pdf-parser.py steel2.pdf -O -r 10
````
#### Aditional Considerations with PDFs
- Look for risky objects, examine them, follow the trail of referenced or otherwise related objects
- If you see a suspicious object with a stream you can dump that stream to a file using parameters `-f -w -d`
- Malicious PDFs can include JS --> look for `/JS /Javascript /Acroform /XFA`
- PDF files could be password protected 
- The strucutre will be visible but youll need to decrypt streams to examine them
- Youll need to determine the password then decrypt with tolls such as `qpdf` and `pdftk`
## VBA Macros in Microsoft OFfice Documents
- Note: Even if the document of VBA project is password protected the macros are not stored in an encrypted way 

- **Office docsuments can follow two different formats**
- The "legacy" binary format is OLE2 (a.k.a structured storage etc)
- OLE2 mimics capabilities of a file system using the concepts of storages (like folders) and streams (like files)
- The more modern XML based format OOZML incorporates multiple files that include the documents contents in a ZIP file
- Both formats can carry  macros 
- Macros in an OOZML file are inside a binary OLE2 file which is inside the zip archive
- Normally VBA macro code is embedded inside streams as compiled code (p-code) and compressed source code
## Initial Triage
````
file particulars.doc
trid particulars.doc
````
## trid
- Open XML Format --> means its an OOXML files

### Examine the files that comprise the OOXML document using `unzip` or `zipdump.py`
````
zipdump.py particulars.doc 
unzip particulars.doc -d particulars-files
````
- Can extract individual files as well with `zipdump.py` 
- `-s` --> specify the file 
- `-d` --> extract or dump it
````
zipdump.py particulars.doc -s 5 -d > image1.jpeg
````
- Use `feh` image viewer to view the image 
````
feh image1.jpeg &
````

## `olevba` to extract VBA Macros 
````
olevba particulars.doc > particulars.olevba #extract
code particulars.olevba #view
````
- `olevba` utility can locate, decode, and extract VBA macros from Office files.  The tool also shows a summary of the risky keywords it located in the macro 
- Any line that starts with `'` it is a comment in VBA
- When Office sees `AutoOpen` it automatically executes that function as soon as the function is allowed to run 
- Example:
````
Sub AutoOpen()
g
End Sub 
-----------------------------------------
Sub g()
' useless comment 
' another useless comment for obsfucation 
y
' blah
' blah blah 
B
End Sub
````
- Can see that `AutoOpen()` calls `Sub g()` which then call function `y` and function `B` which are defined later 
- **For deeper visibility into VBA macros and related artifacts examine streams**
- Use `oledump.py`
````
oledump.py particulars.doc -i
````
- `M` means there is a macro present
- `2823+809` Size of the compiled code is the first number, second number is the size of the compressed source code
- Example:
````
A3: M 3632 2823+809 'VBA/Pj
````
- Use `-s a` parameter to oledump.py to extract VBA macros from all streams in `particulars.doc`
````
oledump.py particulars.doc -s a -v | more
````
- **Pass the `oledump.py` output through `grep` to eliminate the comments**
````
oledump.py particulars.doc -s a -v | grep -v "^'" | more
````
- **Sometimes minor aspects of the document can offer additional context for your investigation**
- They can sometimes reveal artifacts used in its previous version 
- Use `oledump.py` to extract them 
- 


























