# Analyzing Malicious Documents 
- **PDF files can possess powerful capabilities that adversaries misuse to infect systems**
- The structure and contents of a PDF file are defined using objects, which issue directives using ASCII based keywords
- Same risky keywords include 
````
Execute Embedded Javascript --> /JS /Javascript /AcroForm /XFA
Try launching external or embedded programs --> /Launch /EmbeddedFiles
Take actin automatically when the PDF file is opened --> /AA /OpenAction
Interact with websites --> /URI /SubmitForm
````
- **A PDF file is a collection of elements**
````
header --> %PDF-1.6
object --> object delimited with: 
X Y obj 
endobj
...
xref --> Table with offsets of objects in the file
trailer --> Lists the number of objects and the offset of xref
````
- **PDF objects can reference eachother and specify actions**
- Indirect object 1 0 references 43 0
````
1 0 obj 
Type: /Page
<<
  /AA /O 43 O R
>>
endobj
````
- **Streams can encode various data**
````
44 0 obj 
<<
  /Filter 
    [/FlatDecode]
  /Length 463
>>
stream
    encoded contents
endstream 
endobj
````
- **Always start by opening the sample in vs-code**
````
unzip steel1.zip
code steel1.pdf
````
- **Use `pdfid.py` for an initial perspective to check for risky keywords**
- `pdfid.py` scans for suspicious keywords without formally parsing the PDF file
- Its useful for an initial review to inform the next steps 
- The `/URI` keyword indicates clickable URLs can be used in PDFs as phishing bait 
- We use "keyword" in a generic sense through PDF specs use other terms 
````
pdfid.py steel1.pdf
````
- **Use `pdf-parser.py` for a more detailed look at the PDF file**
- The `-a` parameter to `pdf-parser.py` shows statistics 
- Because `pdf-parser.py` properly parses PDF syntac, its output is more accurate than that of `pdfid.py`
````
pdf-parser.py steel1.pdf -a 
````
- **The `-k` parameter shows just the values for the given key**
````
pdf-parser.py steel1.pdf -k /URI
````
## Images in PDF Documents
- The attacker tries to persuade the victim to clicking on the picture 
- To locate images in the PDF file, look for objects of type `/XObject`
## Examine an Object
- Use the `-o` parameter to `pdf-parser.py` to examine object 6 which contains `/XObject`
````
pdf-parser.py steel1.pdf -o 6
````
````
obj 6 0
  Type: /XObject
  Referencing 7 0 R
  Contains Stream     <-- Object includes encoded data
  
  <<
    /Type /XObject
    /Subtype /Image
    /Width 625      <-- Image size is 625 x 155 pixels
    /Height 155
    /BitsPerComponent 8
    /ColorSpace /DeviceRBG
    /Length 7 0 R
    /Filter /DCTDecode      <-- This decoding is used for JPEG images
  >>
````
## Extract and view the image object 
````
pdf-parser.py steel1.pdf -o 6 -d object6.jpg
````
- **Follow the trail of references that leads to object 6 to see if the strail starts with a link**
- The `-r` parameter finds a reference to the specified object
- Object 6 which was of type `/XObject` is referenced by object 13
````
obj 13 0 
  Type:
  Referencing: 4 0 R, 3 0 R, 8 0 R, 9 0 R, 6 0 R
  
  <<
    /ColorSpace
      <<
        /PCSp 4 0 R
        /CSp /DeviceRGB
        /CSpg /DeviceGray
      >>
    /ExtGState
````





























