# svchost.exe
## Static Properties Analysis 
- Hashes
````
md5,C63A537090D34F29DAADBEF221637435
sha1,BA17638BAC43E6E3B2FAF4BF3A22197B99D8A390
sha256,28046C14EA3325885EE1E731CD0BCF9F38445DF02675836B851CB2AE94C050EB
imphash,24C25FC57B04FA4661E2FFA5E8E05726
````
- Basic Information 
````
file-size,104448 (bytes)
entropy,6.129
file-type,executable
cpu,32-bit
````
- Indicators PEstudio
````
The file references file extensions like a Ransomware | Wiper,count: 125,1
````
- Interesting Imports
````
GetDiskFreeSpaceExW
GetLogicalDrives
GetDriveTypeW
GetVolumeNameForVolumeMountPointA
AccessCheck
RegSetValueExW
RegQueryValueExA
RegDeleteValueA
RegSetValueExA
RegCreateKeyExA
RegCloseKey
RegOpenKeyExA
GetVolumeInformationW
GetSystemTime
GetWindowsDirectoryA
IsDebuggerPresent
InternetOpenA
InternetCloseHandle
InternetSetOptionA
HttpOpenRequestA
InternetQueryOptionA
HttpSendRequestExA
InternetWriteFile
HttpEndRequestA
HttpSendRequestA
HttpQueryInfoA
InternetReadFile
InternetConnectA
FindNextFileW
CopyFileW
GetTempPathW
DeleteFileW
MoveFileExW
WriteFile
GetFileSizeEx
CreateFileW
GetFileType
CreateProcessW
Sleep
ExitProcess
ShellExecuteW
CryptCreateHash
CryptHashData
CryptDestroyHash
CryptGenRandom
CryptEncrypt
CryptImportKey
CryptDestroyKey
````
- Interesting Strings
````
POST
Control Panel\Desktop
open
svchost.exe
vssadmin.exe Delete Shadows /All /Quiet
cmd.exe /C del /Q /F "
Software\Locky
Software\Microsoft\Windows\CurrentVersion\Run
rupweuinytpmusfrdeitbeuknltf/main.php
.tmp
.locky
n\_Locky_recover_instructions.txt
\_Locky_recover_instructions.bmp
_Locky_recover_instructions.bmp
_Locky_recover_instructions.txt
$Recycle.Bin
&encrypted=
 delete[]
 new[]
MessageBox
&act=stats&path=
Windows 2000
Windows XP
Windows 2003
Windows 2003 R2
Windows Vista
Windows Server 2008
Windows 7
Windows Server 2008 R2
Windows 8
Windows Server 2012
Windows 8.1
Windows Server 2012 R2
Windows 10
Windows Server 2016 Technical Preview
unknown
&x64=
&sp=
&os=
&serv=
&corp=
&lang=
&act=getkey&affid=
Tahoma
WallpaperStyle
TileWallpaper
pubkey
paytext
completed
&act=gettext&lang=
Locky
0123456789ABCDEF
HTTP/1.1
http://
````
- Can absolutley determine this is ransomware after seeing the strings
- Attribution to `Lockbit` ransomware based on string analysis 

- More than likely some ransomware varient, alot of interesting imports that are potential good breakpoints in `x86db`
## Reversing in Ghirda 
- Basic Information 
- ![image](https://user-images.githubusercontent.com/75596877/170784856-0706a3a6-6146-41f4-aae7-20c846b3b69a.png)
### RegOpenKeyExA
- Two calls to the API
- ![image](https://user-images.githubusercontent.com/75596877/170786468-1fd9ba00-e10e-4ef0-9516-d1ce9251623b.png)
- 0x004047f0
- `Set Equate` on value `0x80000001`
- Can see its opening the `HKCU` hive 
- Querying the `Run` key
- ![image](https://user-images.githubusercontent.com/75596877/170786890-4131bc05-3b07-4e8c-8594-fafbac7b5415.png)
- Rename this function to `Reg_Open_Run_Key`
- If unsuccessful it will `JMP` to `throw exception`
- ![image](https://user-images.githubusercontent.com/75596877/170787554-0e064b80-b4ed-4021-858f-00f6513e5ed1.png)
- Function it `JMP`'s to:
- ![image](https://user-images.githubusercontent.com/75596877/170787602-a9f3dbc3-79fe-450f-84fa-2066456150f9.png)
- Make sure to rename to something meaningful i.e. `Throw_Exception`

- If it can open the `Run` key:
- ![image](https://user-images.githubusercontent.com/75596877/170787890-50d414c6-edb0-4aed-a78f-c903938c2c4a.png)
- It will `CALL FUN_00404ed2`
- ![image](https://user-images.githubusercontent.com/75596877/170788202-7a48f199-395b-49ae-8ef7-ed4394db36fa.png)
- References to `Locky`
-  0x004047b5
- Delete backups with `vssadmin.exe` 
- ![image](https://user-images.githubusercontent.com/75596877/170787310-c8bd4158-3ebf-4c59-9069-6771076a0a4e.png)
### C2 Functionality
- Popular C2 pattern of API calls in this sample
- ![image](https://user-images.githubusercontent.com/75596877/170788374-7bc7cba5-3553-4eae-8493-b719dc8fd7cc.png)
- ![image](https://user-images.githubusercontent.com/75596877/170788412-9a98422e-cfdb-44ea-a420-8fd1d7f0aecb.png)
- `InternetOpen and InternetConnect` --> Crate your HTTP Connection
- Reference to `InternetOpen`
- ![image](https://user-images.githubusercontent.com/75596877/170788529-335f54df-397b-4079-9162-e19dc06ac5ae.png)
- Can see the `PUSH 0x1` for the `Access Type`
- ![image](https://user-images.githubusercontent.com/75596877/170788853-de35cd5f-f1ce-497c-ac74-3e62c8fe50e6.png)
- `0x1` means `direct to net`
- `HttpOpenRequestA`
- 1 Reference to API 
- ![image](https://user-images.githubusercontent.com/75596877/170788990-95d70911-3821-4976-8d80-11ca1d46a42c.png)
- Can see Ghidra miss-interpret the data type for highlighted `PUSH` instruction
- ![image](https://user-images.githubusercontent.com/75596877/170789106-13089bc8-15b8-4d5f-baa6-52164abc553c.png)
- Click to jump to the function --> right click --> Data --> string
- Will change to see `POST`
- ![image](https://user-images.githubusercontent.com/75596877/170789296-32af1d33-9b8b-4a32-bff3-4fbfaf1e7268.png)
- Can see the type of request, and the page that it is reaching out to
### GetTempFileNameW
- Once call to this API @ `004064e6`
- ![image](https://user-images.githubusercontent.com/75596877/173198152-0de1a680-99c7-4a30-bbab-06be420f808a.png)
- Double click to follow to where it is fedined
- ![image](https://user-images.githubusercontent.com/75596877/173198166-d21da66e-c4f7-4358-8727-854349f3e105.png)
- Switch to `Terminated Unicode` 
- ![image](https://user-images.githubusercontent.com/75596877/173198188-a08a0690-35fd-40b3-a850-2cb727b9d57c.png)
- This provided an excellent IOC
### Defined Strings
- Can view list of IP addreses:
-  ![image](https://user-images.githubusercontent.com/75596877/173198699-be2f90fa-3e67-40f6-abcf-9ba055072479.png)
- Attribution to ransomware group 
- ![image](https://user-images.githubusercontent.com/75596877/173198723-9828b125-ab76-414f-ba29-255b15abe0f3.png)
- ![image](https://user-images.githubusercontent.com/75596877/173198731-d5db64c0-7fb8-499f-88d0-56be8f6e831c.png)
- Vulnerable Systems 
- ![image](https://user-images.githubusercontent.com/75596877/173198750-36e1f1d2-5679-4811-b2ac-cd3dcc773ee8.png)
- Registry modification with `pubkey` 
- ![image](https://user-images.githubusercontent.com/75596877/173198862-8762bb50-0c46-47c6-98c7-0e7505fac462.png)
## x32db
- Single Step until hitting `GetCommandLineA` Can see the file path for program execution 
- ![image](https://user-images.githubusercontent.com/75596877/173199048-2a1f29a1-bb6f-409e-8f0a-1ee697688182.png)
- Will immediately after get value for `ALLUSERSPROFILE=`
- ![image](https://user-images.githubusercontent.com/75596877/173199145-ca20a769-f0b0-42af-bb8c-b75491b530a8.png)
- Debugging is extremely difficult due to its anti debugging capabilities
## API Monitor 
- Set `Internet` and `Microsoft .NET`
- Can observe its C2 activity 
- ![image](https://user-images.githubusercontent.com/75596877/173199420-f0933954-e8fd-4db4-a02c-c28af3c850be.png)
- It will attempt to reach out to the list of IPs we saw in ghidra in a successive order, if it cannot establish a connection it will iterate
- ![image](https://user-images.githubusercontent.com/75596877/173199473-395714d3-2c9f-4116-984d-ee983cd5eb4c.png)
- ![image](https://user-images.githubusercontent.com/75596877/173199481-ef3fe977-46b4-4128-b76b-c45ec541a469.png)
-![image](https://user-images.githubusercontent.com/75596877/173199490-d888910c-4b2c-4fa1-9956-9031d9681598.png)

- ![image](https://user-images.githubusercontent.com/75596877/173199500-f7eb8340-81d5-42db-a2f3-c1975f7ded69.png)
- Will also try and touch some domains
- ![image](https://user-images.githubusercontent.com/75596877/173199512-bb42b400-6e5f-438f-a712-0d0f8f1ac4fb.png)
- From examining `CryptHashData` we can see some of the info it sends back to the C2 server in the clear...Note: It mis identifies my system as Win 8
- ![image](https://user-images.githubusercontent.com/75596877/173199645-c1026abd-b2e2-42ef-a386-69c77ef4c875.png)
- ![image](https://user-images.githubusercontent.com/75596877/173199651-5e748818-b5c8-4c14-b0a2-2a0961576c55.png)
- Select All For API Monitor 
- Can see the `RegCreateKeyExA`
- ![image](https://user-images.githubusercontent.com/75596877/173199781-1588a7ba-a15a-40f4-9df7-316c06ae9c10.png)
- Gets default language with return value 1033
- ![image](https://user-images.githubusercontent.com/75596877/173199856-d3ac1e13-7375-4514-a94d-3f48df304287.png)
- ![image](https://user-images.githubusercontent.com/75596877/173199867-586d6ea5-aa2b-48da-a8b6-a66cd1ef4501.png)
- Other Interesting Findings
- Gets machine GUID
- ![image](https://user-images.githubusercontent.com/75596877/173200047-4f7980fc-93f5-46c7-ba53-addfae99467a.png)
- 

- 



























