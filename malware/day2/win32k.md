# win32k.dll
## Static Properties Analysis 
- Hashes
````
md5,07458ACB129EF3EF233D284361B4E158
sha1,E46B46400D8AF345BAD009FD0B100E1D6A6AE13A
sha256,8088F08A5636CEC3BF8B9F05B6CA2D0B21A76A56199D6CCD1777A6F6A7B9FDDE
````
- Basic Information 
````
file-size,268800 (bytes)
entropy,7.371
file-type,dynamic-link-library
cpu,64-bit
subsystem,GUI
````
- Indicators 
- 11 Level 1 indicators 
````
The file references string(s),type: blacklist, count: 85,1
The file contains another file,signature: unknown, location: .rsrc, offset: 0x00020A4C, size: 54615,1
The file contains another file,signature: unknown, location: .rsrc, offset: 0x0002DFA4, size: 65220,1
The file contains another file,signature: unknown, location: .rsrc, offset: 0x0003DE68, size: 48,1
The file contains another file,signature: unknown, location: .rsrc, offset: 0x0003DE98, size: 160,1
The file contains another file,signature: unknown, location: .rsrc, offset: 0x0003DF38, size: 1184,1
The file contains another file,signature: unknown, location: .rsrc, offset: 0x0003E3D8, size: 5780,1
The file contains another file,signature: unknown, location: .rsrc, offset: 0x0003FA6C, size: 6863,1
The file imports symbol(s),type: blacklist, count: 69,1
The file references a URL pattern,url: http://icanhazip.com,1
The file references a URL pattern,url: 203.183.172.196:3478,1
````
- Sections 
- `pestudio` identifies 7 files in the `.rsrc` section of the `.dll`
````
unknown, offset: 0x00020A4C, size: 54615
unknown, offset: 0x0002DFA4, size: 65220
unknown, offset: 0x0003DE68, size: 48
unknown, offset: 0x0003DE98, size: 160
unknown, offset: 0x0003DF38, size: 1184
unknown, offset: 0x0003E3D8, size: 5780
unknown, offset: 0x0003FA6C, size: 6863
````
- Imports (192)
- Interesting Imports 
````
EnumChildWindows
SendMessageW
OpenMutexW
CreateMutexW
OpenServiceW
OpenSCManagerW
DeleteService
CloseServiceHandle
DuplicateTokenEx
LogonUserW
AdjustTokenPrivileges
LookupAccountSidW
LookupPrivilegeValueW
RegEnumKeyExW
RegOpenKeyW
RegSetValueExW
RegCloseKey
GetSystemInfo
GetLocalTime
GetWindowsDirectoryW
GetComputerNameA
GetVersionExW
QueryPerformanceCounter
GetTickCount
InternetConnectA
HttpSendRequestExW
InternetQueryDataAvailable
InternetReadFile
InternetWriteFile
InternetSetOptionW
HttpQueryInfoW
HttpOpenRequestA
HttpAddRequestHeadersA
HttpSendRequestA
InternetOpenA
HttpEndRequestW
23 (socket)
6 (getsockvalue)
2 (bind)
17 (recvfrom)
20 (sendto)
4 (connect)
CreateFileW
ReadFile
CreateDirectoryW
DeleteFileW
GetTempPathW
MoveFileW
GetCurrentProcessId
TerminateThread
Process32FirstW
Process32NextW
Sleep
CreateThread
GetProcAddress
CryptHashData
CryptDestroyHash
CryptCreateHash
````
- Based on the imports, file clearly performs C2 functions, additionally has alot of the same API calls as ransomware samples
- Interesting Strings (4009)
````
\\.\PhysicalDrive0
\\.\C:
\\.\D:
POST
start fail
open
explorer.exe
chrome.exe
iexplore.exe
Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36
http://icanhazip.com
203.183.172.196:3478
Port restricted NAT
SeDebugPrivilege
SeShutdownPrivilege
\\.\pipe\
%d.%d.%d.%d
%d/%s/%s
/%s/%s/0/%s/%d/%s/%s/
/%s/%s/0/%s/%d/%s/
%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X%02X
%s_W%d%d%d.%s
CPU: %s\r\nProcessors: %d\r\nMemory: %d 
/c "echo N|schtasks /create /tn "%s" /tr "%s" /sc minute /mo 1"
/c "echo N|schtasks /create /tn "%s" /tr "%s" /sc minute /mo 1 /ru "System""
stop %s
user %s %s /add
localgroup %s %s /add
C:\windows\system32\shutdown.exe
Win_7
Win_7_SP1
Win_XP
Win_8
Win_8.1
Win_Server_2003
Win_Vista_SP2
Win_Vista
Win_Vista_SP1
Win_10_IP
Win_10_TH1
unknown
_64bit
noname
%02x
RtlTimeToSecondsSince1970
image/jpeg
application/octet-stream
text/plain
Content-Disposition: form-data; name="%s"\r\n
Content-Type: 
--%s--
Content-Length: 
Accept: text/html\r\nConnection: Keep-Alive\r\n\r\n
botid
ponydata
Code60Stat
httprdc
0.0.0.0:0
datapost
UDP Firewall
Address restricted NAT
Symmetric NAT
unknown NAT
hucDK3%
C:\Windows
/prepare %s
/copy-before %s
/copy-after %s
Administrators
SpecialAccounts
UserList
LimitBlankPasswordUse
SYSTEM\CurrentControlSet\Control\Lsa
fDenyTSConnections
SYSTEM\CurrentControlSet\Control\Terminal Server
fSingleSessionPerUser
7mcic6hxh
Roaming
Local
C:\Windows\
SHA384
ECDSA_P384
SHA256
ECDSA_P256
==General==\r\n
==Users==\r\n
==Programs==\r\n
SYSTEM\CurrentControlSet\services
\r\n==Services==\r\n
WinDefend
C:\Program Files\
microsoftedge
````
## Exeinfo PE
- Not detecting a packer...that is good for us
- ![image](https://user-images.githubusercontent.com/75596877/174627562-c02d9fd0-d3a2-43fb-84a1-d63308bf42c5.png)
- Ensure ASLR is disabled in `CFF Explorer`...is it 
## capa
- `capa` can emulate this sample very well, there is alot of output 
- We can run it with `-v` to see the memory addresses it is finding these MITRE matrix's
- Without `-v`
- ![image](https://user-images.githubusercontent.com/75596877/174626341-6c1d2539-ef60-45ed-b776-96ed3e1d49cd.png)
- ![image](https://user-images.githubusercontent.com/75596877/174626499-8b7f73fe-d1f6-44d8-b3d6-ddc4186712bf.png)
- ![image](https://user-images.githubusercontent.com/75596877/174626566-4ba569ca-1ced-4b64-9cae-5093dd04e30a.png)
- ![image](https://user-images.githubusercontent.com/75596877/174626641-97887b76-845d-41ab-86fa-e8b032a47c69.png)
- With `-v` to find the memory addresses...too much output, only snipping key takeaways for stuff to investigate later/things we did not see in `ghidra`
- ![image](https://user-images.githubusercontent.com/75596877/174627016-df906e61-559b-4f2f-acd6-439956c2a832.png)
- ![image](https://user-images.githubusercontent.com/75596877/174627109-fb6d44cc-145f-48ba-a927-4cb0f0682cab.png)
- ![image](https://user-images.githubusercontent.com/75596877/174627146-3e8d584e-4b55-4851-8e54-96da1753800b.png)
- ![image](https://user-images.githubusercontent.com/75596877/174627205-6c20c2a4-31f6-4d1e-89bd-701aa09472f9.png)
- ![image](https://user-images.githubusercontent.com/75596877/174627247-1c7f8c7a-1a58-492d-a27b-c61c2915b0b5.png)
- ![image](https://user-images.githubusercontent.com/75596877/174627302-a88ea575-18aa-4670-9ce7-c2eed04da325.png)
- ![image](https://user-images.githubusercontent.com/75596877/174627345-d58acee3-c9be-42fa-8bf4-d57733e8ac2f.png)
## speakeasy.py
- `speakeasy` output is alot of the same as `capa` however we can see order in execution
- Also see the call to the `Mutex` that we did not see previously 
- ![image](https://user-images.githubusercontent.com/75596877/174628603-222ee7c7-a6dd-4c03-8f35-10692b41d2a0.png)

- 
## Ghidra 
- Take a look at the `Symbol References` --> Find `ShellExecuteW`
- ![image](https://user-images.githubusercontent.com/75596877/174616555-fbcc423d-ef3d-4bc1-9811-7eac81792077.png)
- Clearly executes a `schtask` for persistence 
- ![image](https://user-images.githubusercontent.com/75596877/174617128-2708c9db-6fb3-46b6-95ed-203e039a74ff.png)
- Renmae function to `schtask_persistance`
- ![image](https://user-images.githubusercontent.com/75596877/174617415-4de0ee13-3072-415f-87e2-d49bc36bfb3c.png)
- Clear to see this function shuts down the users computer 
- ![image](https://user-images.githubusercontent.com/75596877/174617491-27441fee-971d-4efb-8550-fc3137b01e71.png)
- Rename this function 
- ![image](https://user-images.githubusercontent.com/75596877/174617629-b6c6f000-289f-4ca5-9ab3-9cefd8093007.png)
- This function creates another `schtask` different from the previous one
- ![image](https://user-images.githubusercontent.com/75596877/174617723-992a073f-2016-4e36-8cc8-d0e934316021.png)
- Rename the function 
- ![image](https://user-images.githubusercontent.com/75596877/174618753-29c38f58-9044-4adc-9707-93e48a2a5a35.png)
- This call to `ShellExecuteW` clearly adds a user account to the host system
- ![image](https://user-images.githubusercontent.com/75596877/174618870-161946a9-ecbd-4838-a421-605c8bb2dd04.png)
- Includes a sleep of `15` seconds 
- Adds the user to the `Administrators` `localgroup`
- ![image](https://user-images.githubusercontent.com/75596877/174618984-5457832e-6766-4d4f-9f11-c3d9f48c9254.png)
- ![image](https://user-images.githubusercontent.com/75596877/174619033-5332d162-bd71-4d1c-98f9-a24d93525723.png)
- Grabs the `User List` and `Special Accounts` from the registry
- ![image](https://user-images.githubusercontent.com/75596877/174619129-d92fd690-a949-4d5a-bfb4-39df45370f30.png)
- Clear to see the `username` the program sets for the newly created user...great IOC
- ![image](https://user-images.githubusercontent.com/75596877/174619259-7bde723e-9dda-451c-a949-f326acd31cc3.png)
- Unsure if it is getting the userlist from the registry or it is checking to see if it was successful at adding a user
- Rename the function 
- ![image](https://user-images.githubusercontent.com/75596877/174619763-2c7fb26d-e630-4ab7-a50e-dd77adebccb7.png)
- Attempting to close services on the host, includes a sleep of `3` seconds and another for `5` seconds 
- ![image](https://user-images.githubusercontent.com/75596877/174620462-51532ff2-0211-4f32-8f78-cac1690e183f.png)
- ![image](https://user-images.githubusercontent.com/75596877/174620535-01b064e2-3dd7-4f10-885c-efefa9ed947d.png)
- Rename function 
- Move on to `connect`
- ![image](https://user-images.githubusercontent.com/75596877/174621357-6fd63d92-7e1a-4211-b1a3-4a50fa3f2961.png)
- Only 1 call to `connect`
- Attempts to test internet connectivity to `google.com` and `microsoft.com`
- ![image](https://user-images.githubusercontent.com/75596877/174621565-0ecd1f49-a558-4841-8a1f-8d8fa79f20b7.png)
- ![image](https://user-images.githubusercontent.com/75596877/174621597-5803a118-7ba3-4dca-9f0c-599b768358f1.png)
- Rename function 
- Search for strings and find `SeDubugPrivilege`
- Clear to see it will get `CurrentProc`, `LookupPrivilegeValueW` for `SeDubug` and attempt to `AdjustTokenPrivileges` if it does not have `SeDebug`
- ![image](https://user-images.githubusercontent.com/75596877/174622257-3b8a5cff-3a5b-4e33-a344-08334a96a00d.png)
- Rename function
- Search for in the strings for `SeShutdownPrivilege`
- It will attempt to do the same as seen above but for a different privilege now
- ![image](https://user-images.githubusercontent.com/75596877/174622622-a9ed59b4-006c-4510-9d53-8fa8664d20ec.png)
- Rename Function
- In strings find:
- ![image](https://user-images.githubusercontent.com/75596877/174623028-13c3f196-757b-4377-8a2c-c34b11fc2f5d.png)
- Attempts to figure out the version of the OS via the Kernel level call
- ![image](https://user-images.githubusercontent.com/75596877/174623104-41cbe898-10db-46b6-83f5-f9009032eefd.png)
- Notice `param_1` that is getting passed to the function 
- Rename function 
- In strings find:
- ![image](https://user-images.githubusercontent.com/75596877/174624372-23ed94a3-0436-469a-a11f-306f1f7a03cf.png)
- Can see the user-agent that it is calling back with 
- ![image](https://user-images.githubusercontent.com/75596877/174624441-5d58ea69-f00e-40d4-ba8e-2fd32f9eae74.png)
- Makes calls to `InternetConnectA` shortly there after 
- At `180009fe9` can see the call to `NetUserEnum`
- The `NetUserEnum` function retrieves information about all user accounts on a server.
- Rename function 
- String Search, and find:
- ![image](https://user-images.githubusercontent.com/75596877/174634279-4bdf1d1c-4631-4bba-bca3-ded524755741.png)
- Sets the `LimitBlankPasswordUse` to the value of `0`
- ![image](https://user-images.githubusercontent.com/75596877/174634347-5574303c-f31a-4bad-b0cc-5270ec337301.png)
- Sets `DenyTSConnections` to `0` or `false`
- ![image](https://user-images.githubusercontent.com/75596877/174634588-6140ddaf-17ac-41f6-bfc5-f17650044f72.png)
- Same with `SingleSessionPerUser`
- ![image](https://user-images.githubusercontent.com/75596877/174634634-3e48c92e-7705-4f51-b843-a806b12328a2.png)
- Rename function
- Strings Search find:
- ![image](https://user-images.githubusercontent.com/75596877/174635559-0a1ac9b1-01b9-4428-b246-ca0a4b97f027.png)
- Appear to be C2 or bot commands that can be executed server side, can see that it is modular 
- ![image](https://user-images.githubusercontent.com/75596877/174635634-68935026-b4ea-439c-b007-7d89f2874559.png)
- Search for in strings:
- ![image](https://user-images.githubusercontent.com/75596877/174637292-2e629a47-5025-4a27-ba08-b41df836f779.png)
- Can see the malicious C2 server that the implant will reach out to 
- ![image](https://user-images.githubusercontent.com/75596877/174637365-fc1ce036-ecaa-44c2-80d2-4b5d102478dd.png)
- In `Symbol References` look for `GetSystemInfo` only 1 call made
- Can see what it is gathering specifically 
- ![image](https://user-images.githubusercontent.com/75596877/174639505-04724382-e485-4098-a67f-67592f56c52a.png)
-
## External Analysis 
- Virustotal
- https://www.virustotal.com/gui/file/8088f08a5636cec3bf8b9f05b6ca2d0b21a76a56199d6ccd1777a6f6a7b9fdde/detection










-

