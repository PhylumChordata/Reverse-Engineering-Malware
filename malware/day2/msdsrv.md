# msdsrv.exe 
## Static Properties Analysis 
- Hashes
````
md5,75D15D4CCBE37019283C452012345074
sha1,BF72EC64682F7DBD9FA8AA629971D28BE1FC23F6
sha256,EF2D290A0B2CA89C9A70011414AFCA3CFA7605A07912753B8B109283B4110C98
````
- Basic Values 
````
file-size,328704 (bytes)
entropy,5.876
file-type,executable
cpu,32-bit
````
- Two Level 1 Indicators 
````
The file references string(s),type: blacklist, count: 57,1
The file imports symbol(s),type: blacklist, count: 26,1
````
- Sections are normalL `.text, .rdata, .data, .rsrc, .reloc` --> sample does not appear to be packed at this time
- Only the `.text` section is executable 
- `.rdata` section is writable 
- Libraries Used (12)
````
kernel32.dll
user32.dll
advapi32.dll
shell32.dll
ole32.dll
shlwapi.dll
wininet.dll
oleacc.dll
gdi32.dll
winspool.drv
comdlg32.dll
oleaut32.dll
````
- Imports (264) --> Sample is for sure not packed, can see cleartext library names and all of them
- Interesting Imports 
````
CreateWindowExA
GetVersionExA
IsDebuggerPresent
GetLocalTime
GetTimeZoneInformation
GetComputerNameA
GetUserNameA
HttpOpenRequestA
InternetConnectA
HttpSendRequestExA
HttpEndRequestA
InternetReadFile
InternetWriteFile
InternetSetFilePointer
InternetSetStatusCallback
InternetOpenA
InternetQueryDataAvailable
HttpAddRequestHeadersA
InternetCloseHandle
InternetGetLastResponseInfoA
LocalAlloc
GlobalReAlloc
VirtualAlloc
HeapCreate
VirtualFree
GetStringTypeA
GetStringTypeW
CallNextHookEx
SetWindowsHookExA
UnhookWindowsHookEx
ReadFile
WriteFile
CreateFileA
TlsGetValue
TlsAlloc
TlsSetValue
TlsFree
GetCommandLineA
ExitProcess
FreeEnvironmentStringsA
GetEnvironmentStrings
FreeEnvironmentStringsW
Sleep
PostQuitMessage
PostMessageA
OpenClipboard
GetClipboardData
CloseClipboard
WriteConsoleA
WriteConsoleW
````
- Interesting Strings (2103)
````
14.8.1.6
13.9.6.11
POST
DELETE
CLSID\%1
CLSID\%1\ProgID
GetKeyState
GetAsyncKeyState
%s (%s:%d)
%s (%s:%d)
Excep while up %s: %s
http://
HTTP/1.0
%2\protocol\StdFileEditing\verb\0
InitCommonControls
InitCommonControlsEx
HtmlHelp
F#32768
commctrl_DragListMsg
CCmdTarget
MessageBox
"dssds";
"%s"
A_u^?C^alrn/ill
{ClipBoard Data:
-----------------------------------------------------------------------
Title of Windows
#!"q(#%TB;<>;3792+-52+19:3<?407C+(*MQKFan`\
````
## Behavioral Analysis 
- Key Takeaways so far, API pattern of:
````
GetKeyState --> Retrieves the status of a specified key.
GetAsyncKeyState --> Determines if a key is currently up or down, or if it was pressed since the last call to the API
GetWindowText --> Obtains the text of a windows title bar, combined with the previous two APIs an attacker could learn about what window the user is in plus the keys pressed.
OpenClipBoard --> get access to the clipboard and also make sure the application does not make changes to it
GetClipBoardData --> gathers data from the clipboard
CloseClipBoard --> self explanitory 
````
- Set up fakedns, wireshark and execute sample 
- ![image](https://user-images.githubusercontent.com/75596877/181640770-c9563c46-e3d5-4c08-962c-66ebf503c5e6.png)
- Sample stays in the process tree, however makes no call outs to remote IPs
- ![image](https://user-images.githubusercontent.com/75596877/181640901-9b12eaa7-7142-4c20-b655-74a7e89b69c4.png)
- ![image](https://user-images.githubusercontent.com/75596877/181640927-993726c3-c9b1-4ac7-8c28-8826d15e10b8.png)
- File executes with multiple threads 
- ![image](https://user-images.githubusercontent.com/75596877/181641174-a780e990-f2b1-4019-ba71-6c95713d2252.png)
- Start Procmon but do not start capturing 
- Start regshot and take the first shot 
- Now start the capture and execute the sample, let it run for ~3 minutes before taking the second shot and comparing 
- Regshot output
- 11 keys added --> nothing malicious 
- 34 Values added --> 
````
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000\Software\Classes\Local Settings\MuiCache\44\52C64B7E\@zipfldr.dll,-10148: "Compressed (zipped) folder"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000\Software\Classes\Local Settings\MuiCache\44\52C64B7E\@C:\Windows\System32\fsquirt.exe,-2343: "Bluetooth device"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000\Software\Classes\Local Settings\MuiCache\44\52C64B7E\@sendmail.dll,-21: "Desktop (create shortcut)"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000\Software\Classes\Local Settings\MuiCache\44\52C64B7E\@C:\WINDOWS\system32\FXSRESM.dll,-120: "Fax recipient"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000\Software\Classes\Local Settings\MuiCache\44\52C64B7E\@sendmail.dll,-4: "Mail recipient"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000\Software\Classes\Local Settings\MuiCache\44\52C64B7E\@efscore.dll,-101: "File ownership"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000\Software\Classes\Local Settings\MuiCache\44\52C64B7E\@windows.storage.dll,-34575: "Documents"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000_Classes\Local Settings\MuiCache\44\52C64B7E\@zipfldr.dll,-10148: "Compressed (zipped) folder"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000_Classes\Local Settings\MuiCache\44\52C64B7E\@C:\Windows\System32\fsquirt.exe,-2343: "Bluetooth device"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000_Classes\Local Settings\MuiCache\44\52C64B7E\@sendmail.dll,-21: "Desktop (create shortcut)"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000_Classes\Local Settings\MuiCache\44\52C64B7E\@C:\WINDOWS\system32\FXSRESM.dll,-120: "Fax recipient"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000_Classes\Local Settings\MuiCache\44\52C64B7E\@sendmail.dll,-4: "Mail recipient"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000_Classes\Local Settings\MuiCache\44\52C64B7E\@efscore.dll,-101: "File ownership"
HKU\S-1-5-21-1866265027-1870850910-1579135973-1000_Classes\Local Settings\MuiCache\44\52C64B7E\@windows.storage.dll,-34575: "Documents"
````
- 15 Files Added
````
C:\Users\REM\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\DataABackup.lnk
````
- 3 Folders Added 
````
C:\Users\REM\AppData\Roaming\DataBackup
````
- Save off `procmon` as .csv output and load into `procdot`
- Clear to see that a secondary thread does in fact drop that `DataABackup.lnk` file to disk 
- ![image](https://user-images.githubusercontent.com/75596877/181642818-19f1ebdb-901a-4569-a4ce-a3c101caef3d.png)
- Also sets `msdsrv.exe` as value for this key below 
- ![image](https://user-images.githubusercontent.com/75596877/181643128-23e4c94e-b8c3-4f5d-adf8-0a0df91d409a.png)
- Check out the shortcut `.lnk` file dropped to disk 
- `.lnk` file is the persistance mechanism for the malware sample to persist past a reboot
- ![image](https://user-images.githubusercontent.com/75596877/181643304-a0d9261b-19be-4e80-b4ad-7377f0c99dd7.png)
- `capa` emulation 
- `capa` is successful at emulating the sample
- ![image](https://user-images.githubusercontent.com/75596877/181643749-035f1f87-8ffc-4c25-b91c-1a729d475ad0.png)
- ![image](https://user-images.githubusercontent.com/75596877/181643770-c7fabe55-a464-4450-a9ad-2ad235a065b3.png)
- ![image](https://user-images.githubusercontent.com/75596877/181643792-89c201ed-c82f-446e-9a0f-34154a48be9c.png)
- We are most interested in the C2 channel in addition to the keylogging capabilities, run `capa` with `-vv` to see where these occur in memory 
- We will however annotate other memory locations 
````
get geographical location
namespace  collection
scope      function
matches    0x423A99

log keystrokes via application hook (2 matches)
namespace  collection/keylog
scope      function
matches    0x403E80
           0x4042E0

log keystrokes via polling (15 matches)
namespace  collection/keylog
scope      function
matches    0x4024D0
           0x403001
           0x40302E
           0x40305B
           0x403088
           0x4030B5
           0x4030E2
           0x40310F
           0x40313C
           0x403169
           0x403196
           0x4031C3
           0x4031F0
           0x40CB38
           0x40DF72

query remote server for available data
namespace  communication
scope      basic block
matches    0x406B82

receive data (2 matches)
namespace    communication
description  all known techniques for receiving data from a potential C2 server
scope        function
matches      0x40749E
             0x4076C2

send data (2 matches)
namespace    communication
description  all known techniques for sending data to a potential C2 server
scope        function
matches      0x40745B
             0x4075D7

connect to HTTP server
namespace  communication/http/client
scope      function
matches    0x407BB5

create HTTP request
namespace  communication/http/client
scope      function
matches    0x4072C2

read data from Internet (2 matches)
namespace  communication/http/client
scope      function
matches    0x40749E
           0x4076C2

send file via HTTP (4 matches)
namespace  communication/http/client
scope      basic block
matches    0x407472
           0x4075FF
           0x407635
           0x40764F

encode data using Base64
namespace  data-manipulation/encoding/base64
scope      function
matches    0x401300

encrypt data using RC4 PRGA
namespace  data-manipulation/encryption/rc4
scope      function
matches    0x424CB8

open clipboard
namespace  host-interaction/clipboard
scope      function
matches    0x4020B0

read clipboard data
namespace  host-interaction/clipboard
scope      function
matches    0x4020B0
````
- Note the `RC4` encryption that was not noticed before, we would like to check that out as well
- `run_speakeasy.py` anlysis 
````
run_speakeasy.py -t msdsrv.exe -o speakeasy.json 2> speakeasy.txt
````
- When we open `speakeasy.json` in `vscode` we see `temp.txt` that was not noticed before
- ![image](https://user-images.githubusercontent.com/75596877/181644545-3b502ea1-a198-4a00-b3d1-0df5f6e5e042.png)
- In memory strings are interesting as call to `svchost.exe` with two arguments 
- ![image](https://user-images.githubusercontent.com/75596877/181644717-0f953219-7964-4097-ad83-e40e7b4291e1.png)
- Will revisit this in behavioral analysis and see if we can see a spawned `svchost.exe`
- 

## Manual Code Reversing and Debugging 
- Start `Ghidra` and `x32db`
### Ghidra 
- Symbol References: 
- Call to sleep is 400 milliseconds
- Jump to `004043f1`
- ![image](https://user-images.githubusercontent.com/75596877/181660700-b144c893-a751-4b3e-aed4-e3e5ad47f8d2.png)
- Interesting Function that is toward the end of the flow of execution 
- ![image](https://user-images.githubusercontent.com/75596877/181660733-f7a85a77-0f7b-430d-bec7-b7d037e8ac25.png)
- Call to sleep for 2 seconds at the top of the function 
- Convert the idHook to unsigned decimal which = 13 --> Windows docs states 
- ![image](https://user-images.githubusercontent.com/75596877/181661077-254e273f-a582-4161-88f5-b8feded01a68.png)
- Monitoring for keystrokes 
- Step down to address `00404407` and you will notice that the value of `EAX` = `MZ` --> right click `EAX` --> follow in memory map and dump it to a file, fix the dump with `Scylla` and use `PeStudio` to confirm it is a valid PE file.  Will continue analysis with that file later 
### Finding the C2
- `bp InternetOpenA`
- `bp InternetConnectA`
- Run from top and you will hit the first bp `InternetOpenA` --> run again and hit second bp `InternetConnectA` --> debug drop down `Run to User Code` 
- From there single step down until `00407D83` and you will see the C2 server that this sample is communicating back with 
- ![image](https://user-images.githubusercontent.com/75596877/181664029-f7d540ef-4e77-4edc-9b73-59a441db72dc.png)
- From OSINT at the time of writing 7/28/22 there is still an active site at this domain, it claims to be for sale via `epik[.]com` however is this site just designed to look like it is for sale?
- ![image](https://user-images.githubusercontent.com/75596877/181664737-e56cff2a-f149-45e2-9627-b6366c70ffdf.png)
- After investigation of the real `epik[.]com` site and taking a look at their favicon it is clear to see that it is different from the `visitorzilla[.]com` site claiming to be for sale by `epix[.]com`
- Real Site:
- ![image](https://user-images.githubusercontent.com/75596877/181665829-6dde1472-919a-429d-ac4a-236e5876b7d4.png)
- Fake site:
- ![image](https://user-images.githubusercontent.com/75596877/181665845-387c18f2-0fb4-4451-8881-18300e9e4860.png)
- This can further be solidified by examining the cookies in use by both sites:
- Real site:
- ![image](https://user-images.githubusercontent.com/75596877/181666059-72d13d9b-a574-431e-8330-a1437e656d7c.png)
- Fake site:
- ![image](https://user-images.githubusercontent.com/75596877/181666083-373bed35-fcc2-47b6-9666-1879f8edad68.png)
- As if we needed any more evidence, we can extend this analysis further with `Virus Total`
- With a quick `nslookup` we can ascertain that the IP hosting the malicious site is:
- ![image](https://user-images.githubusercontent.com/75596877/181666390-c09cb625-e77c-409d-b7ea-0e79a958ca32.png)
- When examining Virus Total 8 security vendors flag it as malicious:
- ![image](https://user-images.githubusercontent.com/75596877/181666435-39435f73-a367-4952-b83a-5ac161d71908.png)

















