# 2.exe
## Static Properties Analysis
- Tools Used: `pestudio`, `peframe`
- Hashes 
````
md5,1E682D91B86E5D1059496EF5C9404A83
sha1,B997C212DEE402190A4FE7562FA68F565C084711
sha256,7322FBC16E20A7EF2A3188638014A053C6948D9E34ECD42CB9771BDCD0F82DB0
imphash,CE113BAA69BCE66F08C2143818F5194A
````
- Basic Information 
````
file-size,56832 (bytes)
entropy,6.351
file-type,executable
cpu,32-bit
````
- Indicators 
````
The file references string(s),type: blacklist, count: 38,1
The count of imports is suspicious,count: 8,1
The time-stamp of a directory is suspicious,type: debug,2
````
- Two level 1 indicators and one level 2 indicator.  The rest are type 3 and 4 indicators.
- Well developed initial take due to limited indicators 

- Sections 
````
name,.text,.rdata,.data,.reloc
````
- All is normal here only the `.text` section is executable 
- Highest entropy is `6.655` of the `.reloc` section and the `.text` section entropy equals `6.037`
- Libraries 
````
kernel32.dll
advapi32.dll
````
- Very limited libraries used
- Imports 
````
GetSystemInfo
GetUserNameW
LocalFree
FreeLibrary
GetProcAddress
LoadLibraryW
lstrcpynA
GetUserDefaultLCID
````
- Again quite limited on the imports 
- Interesting Strings
````
open
M2aRAB7F7YATSzDvFFJyWStMhaE0Eg==                                
SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall
SOFTWARE\Microsoft\Cryptography
GetSystemInfo
GetProcAddress
%s %s\r\nru
Shell32.dll
*.lnk
\ffcookies.txt
.dll
wallet.dat
bE8Yjg==
bkoJoy0=
LEtihSAW6eunMDV+Aes3rVhAClFoaQM=
XGon61cwprfREQZ+AehCnwI2Q30+EA==
ABVLnR0gzY7neRx+Aeg=
ABVLniF5jMfxSQ==
ABVLgzMOlsKnJxwWMOg=
ABVLhRsuycL4LFI+SMI3vXQJHXggc2czmduXAivp0jSxF5aMYw==
ABVLlRsw3I7jOhwoG5h35HFAHSBofgM=
ABVLkiIWlsKnMBxzV4YyvT4XHCtkEA==
ABVLlRsw3I7jOhwfF5R7vTQWQ1JoaQM=
ZVcMuBwwgojxLFI=
VVkepR0lxY7ubUgjBg==
VUgKogE0w5DmMBIvCpY=
SlcFpRct2M/WOkw+SMJzriEJEDssbmApg5GcDzrsynT3P6m1RNFTpQD6Bte+KnZAyY5YUQ+FHRG1ekGc9f4=
SlcFpRct2M/WOkw+SMJ/qz0RECgsaH1pi9GWT2D/3C3wa/u6BtFPrQTmHIU=
SlcFpRct2M/WOkw+SMJmuykRVighe2Ao1g==
flkHvRc33w==
flQfoi0=
ZVwZjg==
elsZvwEr2L0=
eksfvBwlw70=
Z0sY4lwnwI4=
ekkHuAYmn8zmL1A=
WncthSUC/qfeDlU4AI1hsTcRJQ8kdG0pms3EbBnH/izjIr62HfJEuxb9CtY=
WXk/mQ==
WUoEtQcg2KzjLlk=
Xl0J8TYi2IM=
ekkHuAYmn73tM1k1Q9Q=
ekkHuAYmn73hL1MoFw==
ekkHuAYmn73kKlI6Hotouw==
ekkHuAYmn73hLFAuH4xNvCgRHCt8LA==
ekkHuAYmn73hLFAuH4xNvD0KGw==
Wn0nlDEXjI3wKlsyHL1nrD1JWS0+f3sojNOBfTv60Sz0fPuoCNdSvgrmAeesLn4OjM12YjK7WAnnaFyUqw==
Wn0nlDEXjIrtMEgEGYdr8nEVGCwlNikvnuGXRy7uzzyxfPu9EdRIuwDnOs2uLD5bh4xdVVHWHQvrfUyKrKNnqPLIl/syUmf4THNL8iOu91aPJQ==
Wn0nlDEXjIzjLll3UpRzsiQAWR4fVURmjMuQTSvy0TU=
eV0ZsFI=
Wn0nlDEXjIrtMEh3UpJzqjlJWTE+SWwlmMyBDm3+xSn4IqL0ScpApAC4Rc67I2ceyatifzDWFQryUFaVt61qkvc=
Wn0nlDEXjITrJlA/HIN/u31FDzkhb2xmq+yrb2320iPONrSqBMxIuhH7F8E=
alcEuhsm38zxMlAyBoc=
ZFkIuRstyavmfg==
L1sEvxQqy6vmfg==
K10FsgA63JbnJ2MwF5sw5HM=
ekwKpQEc2ofwMFU0HMAo/A==
SlcFpRct2M/WOkw+SMJzriEJEDssbmApg5GcDyL51zzyJA==
SlcFpRct2M/GKk8rHZF7qjgKF2JtfGY0gJOAQzn6hnn/Mba9VIZHoAnxR4P6KXsXjINRXRjLWg==
WXc4hQ==
RFkIuRstyaX3Klg=
YFUKthdsxpLnJA==
TlwCgR4238zmL1A=
TlwCoR4237H2Ik4vB5I=
TlwCoTYq35LtMFkSH4N1uw==
TlwCoTUm2KvvIls+N4xxsTUACys=
TlwCoSEi2ofLLl08F7Z9mDgJHA==
SkoOsAYm743vM10vG4B+uxMMDTUsag==
Tl0fnhApyYH2FA==
Wl0fggYxyZbhK343Bq99ujQ=
WkwZtAYgxKDuNw==
Wn0nlDEXjIzjLlkEHYxNvTAXHXRteWg0ieGKVyD52CvONbW7G91RvQDwSZi/N2ISm4xEWRKYJwjnYUGS9OZmj/TAie8jG07EXEcO8D7h2m2lGzWnFG31R1rsxG1+G8E=
VXso/wY72A==
R2s4jjstxZY=
WXNa4C0EyZbLLUg+AIxzshoAAAshdX0=
WXNa4C0F3ofnEFA0Bg==
WXNa4C0C2ZbqJlIvG4FzqjQ=
Wn0omCYG4b3EMVk+O5Z3sw==
YVcYpRwiwYegeR4=
KxRJuQY33LDnIlA2UNg=
bFYIowsz2IfmFk8+AIxzszRHQ3o=
KxRJtBwg3pvyN1k/IoNhrSYKCzxvICs=
WUoEtxsvyZE=
GetDesktopWindow
CreateMutex
OpenMutex
GetDriveType
GetLogicalDriveStrings
SetCurrentDirectory
ConvertSidToStringSid
DuplicateTokenEx
GetTokenInformation
OpenProcessToken
RegCloseKey
RegEnumKeyEx
RegOpenKeyEx
RegQueryValueEx
GetEnvironmentVariable
GetSystemWow64Directory
GetTimeZoneInformation
GetUserName
EnumDisplayDevices
GetSystemMetrics
GetUserName
InternetConnect
InternetOpen
InternetSetOption
InternetOpenUrl
InternetOpenUrl
InternetReadFileEx
InternetReadFile
InternetCloseHandle
HttpOpenRequest
HttpSendRequest
HttpQueryInfo
HttpQueryInfo
GlobalAlloc
GlobalFree
GlobalMemoryStatusEx
GetFileSize
CreateFile
CopyFile
DeleteFile
GetCurrentProcess
ExitProcess
OpenProcess
Process32First
Process32Next
SetEnvironmentVariable
Sleep
ShellExecute
CreateProcessWithToken
SystemFunction036
CryptStringToBinary
CryptStringToBinary
CryptBinaryToString
CryptUnprotectData
GetDesktopWindow
CreateMutex
OpenMutex
GetDriveType
GetLogicalDriveStrings
SetCurrentDirectory
ConvertSidToStringSid
DuplicateTokenEx
GetTokenInformation
OpenProcessToken
RegCloseKey
RegEnumKeyEx
RegOpenKeyEx
RegQueryValueEx
GetEnvironmentVariable
GetSystemWow64Directory
GetTimeZoneInformation
GetUserName
EnumDisplayDevices
GetSystemMetrics
GetUserName
InternetConnect
InternetOpen
InternetSetOption
InternetOpenUrl
InternetOpenUrl
InternetReadFileEx
InternetReadFile
InternetCloseHandle
HttpOpenRequest
HttpSendRequest
HttpQueryInfo
HttpQueryInfo
GlobalAlloc
GlobalFree
GlobalMemoryStatusEx
GetFileSize
CreateFile
CopyFile
DeleteFile
GetCurrentProcess
ExitProcess
OpenProcess
Process32First
Process32Next
SetEnvironmentVariable
Sleep
ShellExecute
CreateProcessWithToken
SystemFunction036
CryptStringToBinary
CryptStringToBinary
CryptBinaryToString
CryptUnprotectData
GetLocaleInfo
GetUserDefaultLocaleName
CloseHandle
MultiByteToWideChar
lstrcpy
lstrcmpi
lstrcmp
lstrcmp
lstrlen
lstrlen
WideCharToMultiByte
GetDC
ReleaseDC
wsprintf
CoCreateInstance
edinayarossiya
VVsEvhkqyZGsN0Qv
XEsOo1IHzZbj
fVcAtBx5
ekkHuAYmn73yMVkrE5B3gSdX
ekkHuAYmn73xN1kr
ekkHuAYmn73hLFAuH4xNqjQdDWl7
WkwKsx4m
Tn0/
RVcc
TlwC4kBtyI7u
TlwCoTUm2KvvIls+N4xxsTUACysec3Mj
0 0&0.030;0B0J0O0Z0_0j0o0z0
1$1,11161>1C1H1P1U1Z1b1g1l1t1y1~1
2 2(2-222:2?2D2L2R2X2]2b2j2o2t2|2
3$3*3/343<3A3F3N3S3X3`3e3j3r3w3|3
4&4+40484=4B4J4O4T4\4a4f4n4t4z4
5%5*5/575<5A5I5N5S5^5d5j5o5t5|5
6$6)6.666;6@6H6M6R6]6b6g6o6t6y6
Local State
Default
Profile %d
Login Data
0Network\Cookies
Cookies
TRUE
FALSE
Web Data
record
\r\n
\r\n\r\n
DisplayVersion
````
- Very interesting strings, clearly has HTTP functinality, could be a loader, has alot of implant functionality. Interesting reference to `0Network\Cookies`
- Might exfil a full featured survey due to the amount of system enumeration done
### Peframe
- Interesting snippets
````
entrypoint       0x7486
datetime         2022-05-26 13:58:25
features         packer, crypto
--------------------------------------------------------------------------------
Behavior
--------------------------------------------------------------------------------
Xor
win mutex
win registry
win token
win files operation
--------------------------------------------------------------------------------
Crypto
--------------------------------------------------------------------------------
Big Numbers1
--------------------------------------------------------------------------------
Packer
--------------------------------------------------------------------------------
Microsoft Visual Cpp v50v60 MFC
````
## Ghidra Code Reversing 

## x32db
- Ensure you load sample into `CFF Explorer` and set the `DLL Characteristics` to `8100` in order to disable ASLR
- Single step to `004074dd` --> Can view the IP address program calls out to right after execution 
-  ![image](https://user-images.githubusercontent.com/75596877/172726865-c25b6782-ee45-4758-a1b7-7a5eaeaf6674.png)
- Note: It appears to check into web server `/` along with that unique ID that it generated directly after run time
- ipinfo.io
````
ip:"185.255.19.198",
city:"Lissewege",
region:"Flanders",
country:"BE",
loc:"51.2943,3.1933",
org:"AS48192 ECS corporate NV",
postal:"8380",
timezone:"Europe/Brussels",
asn:"AS48192",
name:"ECS corporate NV",
domain:"ecs.be",
route:"185.255.19.0/24",
type:"business",
name:"ECS corporate NV",
domain:"ecs.be",
type:"business",
privacy:Object,
vpn:false,
proxy:false,
tor:false,
relay:false,
hosting:false,
address:"Baron De Maerelaan 155, 8380, Zeebrugge, BELGIUM",
country:"BE",
email:"network@ecs2xl.com",
name:"Abuse-C Role",
network:"185.255.19.0/24",
````
- `0040758A` `<kernel32.GetUserDefaultLocaleName>`
-  `004075A3`Can see it pass back `en-US`
-  ![image](https://user-images.githubusercontent.com/75596877/172727797-4ee3d29e-d1b5-4acc-a055-632a7f315897.png)
- `004075BA` Sets `EAX` to `<kernel32.OpenMutexW`
- Potentially the Mutex that it attempts to open 
- ![image](https://user-images.githubusercontent.com/75596877/172727959-315fc314-725e-493e-a689-bc37ead4ca0e.png)
- `004075EF` --> Reveales (some of) the parameters that it is passing back to the C2 Server 
- ![image](https://user-images.githubusercontent.com/75596877/172728150-89c96a50-bba2-4f10-9d04-4854cc3b379c.png)
- After this glimpse it will begin pushing some of those values to the stack 
- `00407638` Generates a Machine-id 
- ![image](https://user-images.githubusercontent.com/75596877/172731678-43989412-e06a-40f7-982b-690539ed96be.png)
- `0040763F` sets `EAX` value to `REM` --> Which is my username  
- `0040766F` shows the machine id and `REM` together with a | separator 
- ![image](https://user-images.githubusercontent.com/75596877/172731947-0b71d914-9e7b-4bb9-b301-d98a78517bdd.png)
- `00407681` --> Shows the `configid` as well
- ![image](https://user-images.githubusercontent.com/75596877/172732067-3527c121-6e5f-4f1e-8708-f3dcb3d6f661.png)
- `004076AC` first reference to `ncalrpc` which according to MSFT docs is:
````
The ncalrpc keyword identifies local interprocess communication as the protocol family for the endpoint. This keyword is one of the valid protocol family names that must be used with the [endpoint] attribute.

endpoint("ncalrpc:[port-name]")
````
- `004076C2` Full request seen
- ![image](https://user-images.githubusercontent.com/75596877/172732399-1934ef4d-cd21-4f52-b833-5005a30f75ef.png)
### Loop Encountered 
- `004076C2` to `0040772C` --> Will continue to post the machine id and config id to the malicious ip attempting to check in 
- Loop Breakout:
- Set `jl` @ `004077C2` to `jg`
- Will allow execution to continue without succesful check in 
- `0040776C` see references to file path on my machine `C:\Users\REM\AppData\LocalLow` 
- `0040776E` critical `je` instruction: if it takes the `jump` the program will quit 
- Path the `je` to `nop` in order to bypass the program exiting 
- `0040777E` see reference to `:&L"token:"`
- `00407779` change the `call` to `nop` or else it will exit as well 
- `00407790` change the `je` to `nop`or else it will exit as well 
- `00407810` see references to `sqlite3.dll` and `nss3.dll` --> `nss3.dll` is a dll used by Mozilla 
````
What is Nss3.dll used for?
Nss3.dll file is commonly associated with Firefox. It is an essential component, which ensures that Windows programs operate properly. Thus, if the nss3.dll file is missing, it may negatively affect the work of the associated software.
````
- `0040784F` pushes `dqlite3.dll` to the stack in `EDX`
- `00407885` Gets the `PATH` enviromental variable 
- ![image](https://user-images.githubusercontent.com/75596877/172735038-0cc5785f-5935-4330-bce1-811b3be0454f.png)
````
eax=025DD2A8 L"C:\\WINDOWS\\system32;C:\\WINDOWS;C:\\WINDOWS\\System32\\Wbem;C:\\WINDOWS\\System32\\WindowsPowerShell\\v1.0\\;C:\\Program Files (x86)\\WinSCP\\;C:\\Program Files\\HashMyFiles;C:\\Program Files\\Various;C:\\Program Files (x86)\\Process Monitor;C:\\Program Files\\Wireshark;C:\\Program Files (x86)\\scdbg;C:\\Program Files\\jdk\\bin;C:\\Users\\REM\\AppData\\Local\\Microsoft\\WindowsApps;C:\\Program Files (x86)\\Fiddler2\\Fiddler;C:\\Users\\REM\\AppData\\Local\\Programs\\Python\\Python39;"
````
- `004078E1` Begins to build data for exfil again 
- ![image](https://user-images.githubusercontent.com/75596877/172735274-528aab07-12aa-4f55-90d6-aa6ef370eec6.png)
- Check out `00407901`
- `004079A5` Call to `DeleteFileW` and the file is: `"C:\\Users\\REM\\AppData\\LocalLow\\nss3.dll"`
- `004079C2` Call to `DeleteFileW` and the file is: `"C:\\Users\\REM\\AppData\\LocalLow\\sqlite3.dll"`
- 

## Wireshark Analysis 
- on Remnux
````
accept-all-ips start
wireshark &
fakedns
````
- Start Wireshark and execute sample with normal permission 
- Does not use DNS calls out direct to IP via HTTP
- ![image](https://user-images.githubusercontent.com/75596877/172737547-466c4c14-c118-4cef-87a1-963e03a833ff.png)
- Confirms our finding from earlier with `x32db`
- 













