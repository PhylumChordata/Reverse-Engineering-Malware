# pdfxcview.exe
## Static Properties Analysis
- Hashes 
````
md5,15AF6227D39CA3F9D1DCD8566EFB0057
sha1,C8C3BF9ED944B614AE4B3E747E69E84026FB4039
sha256,40050153DCEEC2C8FBB1912F8EEABE449D1E265F0C8198008BE8B34E5403E731
````
- Basic Information 
````
file-size,431884 (bytes)
entropy,7.483
description,PDF-XChange Viewer
file-type,executable
cpu,32-bit
````
- Indicators (48), there are (6) Level 1 indicators 
````
The file references string(s),type: blacklist, count: 92,1
The file contains another file,signature: unknown, location: overlay, offset: 0x00069400, size: 780,1
A directory is invalid,type: debug,1
The file contains resource(s) in a language tagged as blacklist,language: chinese-Hong Kong,1
The file contains another file,signature: unknown, location: .rsrc, offset: 0x00069260, size: 28,1
The file imports symbol(s),type: blacklist, count: 34,1
````
- Some of the Interesting Imports (367)
````
CheckTokenMembership
RegSetValueExA
RegCreateKeyExW
RegEnumKeyExA
RegQueryValueExA
RegOpenKeyExW
RegSetValueExW
RegCloseKey
RegEnumValueA
RegOpenKeyExA
IsDebuggerPresent
GetSystemDirectoryA
52 (gethostbyvalue)
InternetGetConnectedState
InternetSetOptionA
InternetCloseHandle
InternetOpenA
HttpQueryInfoA
InternetGetConnectedStateExA
InternetErrorDlg
HttpAddRequestHeadersA
HttpSendRequestA
InternetWriteFile
UnhookWindowsHookEx
SetWindowsHookExA
MoveFileA
RemoveDirectoryW
ShellExecuteExA
ShellExecuteW
GetProcAddress
CryptDeriveKey
CryptDecrypt
CryptCreateHash
CryptHashData
CryptReleaseContext
CryptEncrypt
````
- Some Interesting Strings (4941) 
````
tifyTransition(GPLUGIN_EVT_CLEAR, %d) = 0x%08x
Undo the last action\r\nndo&Redo the previously undone action\r\nedo
Save the active document\r\nave0Save the active document with a new name\r\nave As&Change the printing options\r\nage Setup3Change the printer and printing options\r\nrint Setup
Reverse Order
Repeat the last action\r\nepeat1Replace specific text with different text\r\neplace%Select the entire document\r\nelect All
ReleaseMutex
Please enter valid user or owner password for the document:
Erase the selection\r\nrase
Erase everything\r\nrase All3Copy the selection and put it on the Clipboard\r\nopy1Cut the selection and put it on the Clipboard\r\nut
Enlarge the window to full size"Switch to the next document window&Switch to the previous document window9Close the active window and prompts to save the documents
2.rO
2.5.0314.0000
!This program cannot be run in DOS mode.
````
- There are not many interesting strings, sign of malware packing 
- Re-checked Entropy 
````
entropy,7.483
````
- Also points to packing 
- `Exeinfo PE`
````
Borland Delphi ( 2.0 - 7.0 ) 2003 - borland.com - [ modified ] - NONSTANDARD R/W section FLAG  , 
Overlay : 233F15... Nothing detected
````
## Behavioral Anaysis 
- Run `Process Hacker 2` and `Procmon` --> start sample, wait roughly 5 minutes
- Process will die and then spawn two `regserv32.exe` processes 
- Once those two spawn pause capture and kill the processes, then `procmon --> tools --> process tree`
- ![image](https://user-images.githubusercontent.com/75596877/173934584-d703f4ed-c226-4d78-b889-21249a5f1ba8.png)
- Notice the `mshta.exe` process 
- ![image](https://user-images.githubusercontent.com/75596877/173934825-bb76d25f-eae5-4ec0-9b72-4b229349c456.png)
- ![image](https://user-images.githubusercontent.com/75596877/173934855-7b3f0423-1f50-48a5-a335-e220d856bbc2.png)
- save off `procmon` capture as `.csv`
- Load into procdot and attatch to the PDF process 
- ![image](https://user-images.githubusercontent.com/75596877/173935370-06944c59-a25b-4bf9-b9db-c70a3ea8d7ac.png)
- Notice all the new registry entries 
- ![image](https://user-images.githubusercontent.com/75596877/173935519-4e82c2ec-54a4-4019-be4b-b3f21d86f966.png)
- Note the two files created in `%appdata` 
- ![image](https://user-images.githubusercontent.com/75596877/173935625-37d74837-2e23-4101-9fef-9e44bda88189.png)
- ![image](https://user-images.githubusercontent.com/75596877/173935680-f90992af-f42b-43ab-a7bd-dd56e4dac1f1.png)
- `bdf6.bat`
- ![image](https://user-images.githubusercontent.com/75596877/173935736-c31d8199-6ad5-449b-91b6-5fe68de37bb8.png)
- It starts the other file in that directory with a strange file extension 
- Second file is an absolute mess
- ![image](https://user-images.githubusercontent.com/75596877/173935817-a1c33f80-a33a-4c87-bdb8-a2d2fd0b9c62.png)
- Examine the registry value with the same path as the file extension 
- ![image](https://user-images.githubusercontent.com/75596877/173936019-2a179573-ddcf-4b36-9cc3-34908d7fd423.png)
- - Contains value `0346`
- ![image](https://user-images.githubusercontent.com/75596877/173936398-8c7af7c7-e117-42d8-9029-cb56ec623bec.png)
- Now find the registry key in the same hive with the value `0346`
- ![image](https://user-images.githubusercontent.com/75596877/173937024-a8b25be6-b54c-4d29-bf68-e442d6d86262.png)
- `Computer\HKEY_CURRENT_USER\Software\Classes\0346\shell\open\command`
- Copy out the command in the data value of the key, paste into `notepad ++`
- It appeas to contain javascript and the program called is that `mshta.exe` we saw in the process list 
- ![image](https://user-images.githubusercontent.com/75596877/173937513-ca2c4762-983d-4f33-96cf-b52b05740ca8.png)
- The JS is obsfucated however we see a reference to yet another registry key 
- ![image](https://user-images.githubusercontent.com/75596877/173937807-02b22c14-9249-450c-a734-177a72beef79.png)
- Open up that key now 
- There are many keys with values in with the same parent key called by the javascript 
- ![image](https://user-images.githubusercontent.com/75596877/173938307-f4afc553-86a7-4dec-9012-ff6e0ec0b9a3.png)
- Export the obsfucated javascript from the called registry key we see above 
````
reg_export HKCU\Software\gxyhwinsg zbrqoytjz script.js 
````
- Open with `notepad ++` its a mess
- ![image](https://user-images.githubusercontent.com/75596877/173939693-297c32dc-180d-4304-9060-7072ae39b82b.png)
- Need to transfer to REMnux and deobsfucate with `spidermonkey`
- Attempt to run `js` on the file specifying the `objects definition file` as the `-f` parameter
````
js -f /usr/share/remnux/objects.js -f script.js
````
- Get an illegal char error 
- ![image](https://user-images.githubusercontent.com/75596877/173940349-d17b87d5-031e-40aa-8563-02e5ad3e7e75.png)
- Run `xxd` on the file and view it via the hex editor
- Notice that after every char it is followed by a `null` char 
- ![image](https://user-images.githubusercontent.com/75596877/173940505-220d39b7-62db-41eb-b730-c66d78136922.png)
- Fix the file and convert the unicode to ascii in order to allow `spider monkey` to interpret it correctly 
- `cat script.js | tr -d '\00' > script2.js`
- Now run again 
````
remnux@remnux:~/Desktop$ js -f /usr/share/remnux/objects.js -f script2.js > script3.js
````
- Run `js-besutify` against it 
- Much better 
- ![image](https://user-images.githubusercontent.com/75596877/173940783-0edf8fc9-1a06-435c-a2a2-41b83a032aff.png)
- Notice the call to `base64` in the now pretty js file 
- Dump that base64 string with `base64dump.py`
- ![image](https://user-images.githubusercontent.com/75596877/173940864-d6209e93-3548-497b-a494-e287751aa004.png)
- Take note of the `size` column, we want the large one 
- `base64dump.py script4.js -s 13 -d > script.ps1`
- Transfer back to the windows station 
- Edit with `notepad ++`
- ![image](https://user-images.githubusercontent.com/75596877/173941398-53946b37-3b3d-494d-8e85-a6a9cf21dc49.png)
- It looks like shell code interspersed with random block comment chars `<#hr#>`
- ![image](https://user-images.githubusercontent.com/75596877/173941501-620d6f30-ad2b-4244-b2f1-c48bcf2d2734.png)
- Open with powershell ise and set a breakpoint on the comment line `#mulssex`
- 














